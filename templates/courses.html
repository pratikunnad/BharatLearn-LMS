{% extends "base.html" %}
{% block content %}

<script>
document.querySelectorAll(".enroll-btn").forEach(button => {
    button.addEventListener("click", function (e) {
        e.preventDefault();

        const courseId = this.dataset.courseId;

        fetch(`/enroll/${courseId}`, {
            method: "POST"
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // redirect to My Enrollments
                window.location.href = data.redirect;
            }
        });
    });
});
</script>

<h2>Explore Courses</h2>

<!-- Search -->
<form method="get" action="{{ url_for('courses') }}">
    <input
        type="text"
        name="search"
        placeholder="Search courses..."
        value="{{ search }}"
    >
    <button type="submit">Search</button>
    <a href="{{ url_for('courses') }}" class="clear-btn">Clear</a>
</form>

<!-- Filters -->
<form method="get" action="{{ url_for('courses') }}" class="filters">

  <select name="programming_language">
    <option value="">All Languages</option>
    <option value="Python" {{ 'selected' if selected_programming_language == 'Python' }}>Python</option>
    <option value="Java" {{ 'selected' if selected_programming_language == 'Java' }}>Java</option>
    <option value="C++" {{ 'selected' if selected_programming_language == 'C++' }}>C++</option>
  </select>

  <select name="difficulty">
    <option value="">All Levels</option>
    <option value="Beginner" {{ 'selected' if selected_difficulty == 'Beginner' }}>Beginner</option>
    <option value="Intermediate" {{ 'selected' if selected_difficulty == 'Intermediate' }}>Intermediate</option>
    <option value="Advance" {{ 'selected' if selected_difficulty == 'Advance' }}>Advance</option>
  </select>

  <select name="source">
    <option value="">All Sources</option>
    <option value="YouTube" {{ 'selected' if selected_source == 'YouTube' }}>YouTube</option>
    <option value="Udemy" {{ 'selected' if selected_source == 'Udemy' }}>Udemy</option>
    <option value="Coursera" {{ 'selected' if selected_source == 'Coursera' }}>Coursera</option>
    <option value="FreeCodeCamp" {{ 'selected' if selected_source == 'FreeCodeCamp' }}>FreeCodeCamp</option>
  </select>

  <button type="submit">Apply</button>
  <a href="{{ url_for('courses') }}" class="clear-btn">Clear</a>
</form>

<hr>

<!-- Courses -->
<div class="course-container">
{% if courses %}
    {% for course in courses %}
    <div class="course-card">

        {% if course.image_url %}
            {% if course.image_url.startswith('http') %}
                <img src="{{ course.image_url }}" alt="Course Image">
            {% else %}
                <img src="{{ url_for('static', filename='images/' ~ course.image_url) }}" alt="Course Image">
            {% endif %}
        {% else %}
            <img src="{{ url_for('static', filename='images/default-course.png') }}" alt="Course Image">
        {% endif %}

        <h3>{{ course.title }}</h3>
        <p>{{ course.description }}</p>

        <span class="badge">{{ course.programming_language }}</span>
        <span class="badge">{{ course.difficulty }}</span>
        <span class="badge">{{ course.source }}</span>

        <!-- Enroll / Unenroll -->
        {% if course.is_enrolled %}
    <button class="btn btn-success" disabled>
        Enrolled
    </button>
{% else %}
    <button
        class="btn btn-primary enroll-btn"
        data-course-id="{{ course.id }}"
    >
        Enroll
    </button>
{% endif %}


    </div>
    {% endfor %}
{% else %}
    <p>No courses found ðŸ˜•</p>
{% endif %}
</div>

<!-- Pagination -->
<div class="pagination">

{% if page > 1 %}
<a href="{{ url_for('courses',
    page=page-1,
    search=search,
    programming_language=selected_programming_language,
    difficulty=selected_difficulty,
    source=selected_source) }}">
  Previous
</a>
{% endif %}

<span>Page {{ page }} of {{ total_pages }}</span>

{% if page < total_pages %}
<a href="{{ url_for('courses',
    page=page+1,
    search=search,
    programming_language=selected_programming_language,
    difficulty=selected_difficulty,
    source=selected_source) }}">
  Next
</a>
{% endif %}

</div>

<a href="/">Back to Home</a>

<!-- AJAX Enroll -->
<script>
document.querySelectorAll(".enroll-btn").forEach(btn => {
    btn.addEventListener("click", function () {
        const courseId = this.dataset.courseId;
        const button = this;

        fetch(`/enroll/${courseId}`, { method: "POST" })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("You have successfully enrolled in this course!");
                    window.location.href = "/my-enrollments";
                }
            });
    });
});
</script>

{% endblock %}